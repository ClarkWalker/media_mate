<!DOCTYPE html>
<html lang="en">
<head>
	<!-- inject:css -->
	<link rel="stylesheet" href="index.css">
	<link rel="stylesheet" href="node_modules/bulma/css/bulma.css">
	<link rel="stylesheet" href="node_modules/izitoast/dist/css/iziToast.min.css">
	<!-- endinject -->
	<!-- inject:js -->
	<script src="renderjs/render-err.js"></script>
	<script src="renderjs/streamer.js"></script>
	<!-- endinject -->
    <meta charset="UTF-8">
    <title>Media Mate Downloader</title>
</head>
<body>
<script type="text/javascript">
	const RSSParse = require('./lib/rssparse').RSSParse;
	const MongoClient = require('mongodb').MongoClient
		, assert = require('assert');
//	const WebTorrent = require('webtorrent');
	const _ = require('underscore');
	const url = 'mongodb://localhost:27017/media_mate';
	function insertRSSURI(uri, db, callback) {
		let collection = db.collection('uri');
		collection.insertOne({showRSSURI: uri}, (err, res) => {
			assert.equal(err, null);
			callback(res)
		})
	}
	function ignoreDupeTorrents(torrent, db, callback) {
		let collection = db.collection('torrents');
		if (collection.find() !== null) {
			collection.findOne({magnet: torrent.link}, (err, docs) => {
				if (docs === null) {
					collection.insertOne({magnet: torrent.link}, (err, res) => {
						console.log(err);
						callback()
					})
				} else {
					callback('dupe');
				}
			})
			} else {
			collection.insertOne({magnet: torrent.link}, (err, res) => {
				callback()
			})
		}
	}
	function updateURI (uri, db, callback) {
		// Get the documents collection
		let collection = db.collection('uri');
		// Update document where a is 2, set b equal to 1
			collection.drop();
			collection.insertOne({showRSSURI: uri}, (err, res) => {
			assert.equal(err, null);
			console.log("Updated the showRSS uri");
			callback(res);
		})
	}
	function findDocuments(db, col, callback) {
		// Get the documents collection
		let collection = db.collection(col || 'uri');
		// Find some documents
		collection.find({}).toArray(function(err, docs) {
			assert.equal(err, null);
			console.log("Current contents of " + col);
			console.log(docs);
			callback(docs);
		});
	}
	// Use connect method to connect to the Server
	MongoClient.connect(url, function(err, db) {
		assert.equal(null, err);
		console.log("Connected correctly to server");
		findDocuments(db, 'torrents', function() {
			db.close();
		});
	});

	function runScript(e) {
		if (e.keyCode == 13) {
			const tb = document.getElementById('rss');
//			storage.set('showRSSURI', {uri: tb.value}, function (error) {
//				if (error) throw error
//			});
			// Use connect method to connect to the Server
			MongoClient.connect(url, function(err, db) {
				assert.equal(null, err);
				console.log("Connected correctly to server");
					updateURI(tb.value, db, () => {
					db.close();
				});
			});
			let dl = document.getElementById("dlbox");
			document.getElementById("dls").style.display = 'inline';
			let RSS = new RSSParse(tb.value);
			MongoClient.connect(url, function(err, db) {
				assert.equal(null, err);
				console.log("Connected correctly to server");

				RSS.on('data', data => {
					data = _.omit(data, '_id');
					ignoreDupeTorrents(data, db, dupe => {
							if (!dupe) {
							let br = document.createElement('br');
							let label = document.createElement("label");
							let input = document.createElement('input');
							let inputName = document.createTextNode(data.title);
							label.appendChild(inputName);
							input.type = "checkbox";
							input.name = data.link;
							input.className = 'checkbox';
							input.textContent = data.title;
							input.addEventListener("click", function () {
								input.style.display = 'none';
								client.add(input.name, {path: 'F:\\media_mate'}, function (torrent) {
									console.log(torrent);
								});
							});
							label.appendChild(input);
							dlbox.appendChild(document.createElement("br"));
							console.log(input);
							document.getElementById('dlbox').appendChild(label);
						} else {
								console.log('dupe');
							}
					});
				});
//				db.close();
			});
			return false;
		}
	}
</script>
<section class="hero is-primary is-bold">
	<div class="hero-body">
		<div class="container">
			<h1 class="title">
				Downloading
			</h1>
			<h2 class="subtitle">
				Paste a <a href="http://showrss.info">ShowRSS</a> feed below
			</h2>
		</div>
	</div>
</section>
<div class="columns">
	<div class="column is-narrow">
	</div>
	<div class="column">
		<div class="box">
			<p id="rssp" class="subtitle"><input id="rss" placeholder="Paste ShowRSS feed url." type="text" onkeypress="return runScript(event)" title="magnet"></p>
		</div>
	</div>
</div>
<div id="dls" style="display: none;">
	<form id="dlbox">

	</form>
</div>
</body>
</html>
